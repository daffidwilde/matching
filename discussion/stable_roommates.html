<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>matching – stable_roommates</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">matching</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../tutorials/index.html" rel="" target="">
 <span class="menu-text">tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../how-to/index.html" rel="" target="">
 <span class="menu-text">how-to guides</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../discussion/index.html" rel="" target="" aria-current="page">
 <span class="menu-text">discussion</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../reference/index.html" rel="" target="">
 <span class="menu-text">reference</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../citation.html" rel="" target="">
 <span class="menu-text">citations</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../contributing.html" rel="" target="">
 <span class="menu-text">contributing</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../bibliography.html" rel="" target="">
 <span class="menu-text">bibliography</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/daffidwilde/matching" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://doi.org/10.21105/joss.02169" rel="" target=""><i class="bi bi-journal-text" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../discussion/index.html">Discussion</a></li><li class="breadcrumb-item"><a href="../discussion/stable_roommates.html">The stable roommates problem</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="../discussion/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Discussion</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../discussion/hospital_resident.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The hospital-resident assignment problem</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../discussion/other_packages/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Other packages</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../discussion/stable_marriage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The stable marriage problem</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../discussion/stable_roommates.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">The stable roommates problem</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../discussion/student_allocation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The student-allocation problem</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#stable-roommates" id="toc-stable-roommates" class="nav-link active" data-scroll-target="#stable-roommates">The stable roommates problem</a>
  <ul class="collapse">
  <li><a href="#key-definitions" id="toc-key-definitions" class="nav-link" data-scroll-target="#key-definitions">Key definitions</a>
  <ul class="collapse">
  <li><a href="#the-game" id="toc-the-game" class="nav-link" data-scroll-target="#the-game">The game</a></li>
  <li><a href="#matching" id="toc-matching" class="nav-link" data-scroll-target="#matching">Matching</a></li>
  <li><a href="#blocking-pair" id="toc-blocking-pair" class="nav-link" data-scroll-target="#blocking-pair">Blocking pair</a></li>
  </ul></li>
  <li><a href="#an-example" id="toc-an-example" class="nav-link" data-scroll-target="#an-example">An example</a></li>
  <li><a href="#the-algorithm" id="toc-the-algorithm" class="nav-link" data-scroll-target="#the-algorithm">The algorithm</a>
  <ul class="collapse">
  <li><a href="#phase-1" id="toc-phase-1" class="nav-link" data-scroll-target="#phase-1">Phase 1</a></li>
  <li><a href="#phase-2" id="toc-phase-2" class="nav-link" data-scroll-target="#phase-2">Phase 2</a></li>
  </ul></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">



<section id="stable-roommates" class="level1">
<h1>The stable roommates problem</h1>
<p>The stable roommates problem (SR) describes the problem of finding a stable matching of pairs from one even-sized set of players, all of whom have a complete preference of the remaining players.</p>
<section id="key-definitions" class="level2">
<h2 class="anchored" data-anchor-id="key-definitions">Key definitions</h2>
<section id="the-game" class="level3">
<h3 class="anchored" data-anchor-id="the-game">The game</h3>
<p>Consider a set of <span class="math inline">\(N\)</span> players <span class="math inline">\(P\)</span> where <span class="math inline">\(N\)</span> is even. Each player in <span class="math inline">\(P\)</span> has a ranking of all other players in <span class="math inline">\(P\)</span>, and we call this ranking their preference list.</p>
<p>We can consider the preference lists of each player as a function which produces tuples. We denote this function as <span class="math inline">\(f\)</span> where:</p>
<p><span class="math display">\[f : P \to P^{N-1}\]</span></p>
<p>This construction of players and their preference lists is called a game of size <span class="math inline">\(N\)</span>, and is denoted by <span class="math inline">\(P\)</span>. This game is used to model instances of SR.</p>
</section>
<section id="matching" class="level3">
<h3 class="anchored" data-anchor-id="matching">Matching</h3>
<p>A matching <span class="math inline">\(M\)</span> is any pairing of the elements of <span class="math inline">\(P\)</span>. If a pair <span class="math inline">\((p,q) \in P \times P\)</span> are matched in <span class="math inline">\(M\)</span>, then we say that <span class="math inline">\(M(p) = q\)</span> and, equivalently, <span class="math inline">\(M(q) = p\)</span>.</p>
<p>A matching is only considered valid if all players in <span class="math inline">\(P\)</span> are uniquely matched with exactly one other player.</p>
</section>
<section id="blocking-pair" class="level3">
<h3 class="anchored" data-anchor-id="blocking-pair">Blocking pair</h3>
<p>A pair <span class="math inline">\((p,q)\)</span> is said to block a matching <span class="math inline">\(M\)</span> if <strong>all</strong> of the following hold:</p>
<blockquote class="blockquote">
<ol type="1">
<li>Both <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> have a match in <span class="math inline">\(M\)</span>.</li>
<li><span class="math inline">\(p\)</span> prefers <span class="math inline">\(q\)</span> to <span class="math inline">\(M(p) = q'\)</span>.</li>
<li><span class="math inline">\(q\)</span> prefers <span class="math inline">\(p\)</span> to <span class="math inline">\(M(q) = p'\)</span>.</li>
</ol>
</blockquote>
<p>The notions of preference and stability here are the same as in SM.</p>
</section>
</section>
<section id="an-example" class="level2">
<h2 class="anchored" data-anchor-id="an-example">An example</h2>
<p>Consider the instance of SR below. Here there are six people looking to bunk together on a school trip - Alex, Bowie, Carter, Dallas, Evelyn and Finn. Their preferences of one another are described in the graph below:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../assets/discussion/sr_matching.svg" class="align-center img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">image</figcaption>
</figure>
</div>
<p>In this representation, a valid matching <span class="math inline">\(M\)</span> creates a 1-regular graph. Again, this graphical representation makes it easy to see the current relationships between the players. Consider the matching below:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../assets/discussion/sr_unstable.svg" class="align-center img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">image</figcaption>
</figure>
</div>
<p>Here we can see that players <span class="math inline">\(C\)</span> and <span class="math inline">\(F\)</span> would rather be matched to one another than their current matches, <span class="math inline">\(D\)</span> and <span class="math inline">\(E\)</span> respectively. Thus, <span class="math inline">\((C, F)\)</span> are a blocking pair in this matching and the matching is unstable. We can attempt to rectify this instability by swapping these pairs over:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../assets/discussion/sr_stable.svg" class="align-center img-fluid figure-img" style="width:80.0%"></p>
<figcaption class="figure-caption">image</figcaption>
</figure>
</div>
<p>Despite this move actually making <span class="math inline">\(D\)</span> worse off, there are no players they envy where the feeling is reciprocated under this matching. With that, there are no blocking pairs and this matching is stable.</p>
</section>
<section id="the-algorithm" class="level2">
<h2 class="anchored" data-anchor-id="the-algorithm">The algorithm</h2>
<p>Robert Irving presented an efficient, two-phase algorithm for finding a stable matching to SR in <code class="interpreted-text" role="cite">Irv85</code>, if one exists. An extended form of the algorithm was presented in <code class="interpreted-text" role="cite">GI89</code>, and is given below.</p>
<section id="phase-1" class="level3">
<h3 class="anchored" data-anchor-id="phase-1">Phase 1</h3>
<p>The first phase of the algorithm consists of one-way proposals (we still refer to these as matches here) and removes unpreferable pairs from the game. Begin by assigning all players to be unmatched and without any proposals. Then, while there is a player, <span class="math inline">\(p\)</span>, who does not have a held proposal and has a non-empty preference list, do the following:</p>
<ol start="0" type="1">
<li>Consider the favourite player of <span class="math inline">\(p\)</span> and call them <span class="math inline">\(q\)</span>.</li>
<li>If <span class="math inline">\(q\)</span> is presently holding a proposal from (i.e.&nbsp;is matched to) another player, <span class="math inline">\(p'\)</span>, drop the proposal. Let <span class="math inline">\(p\)</span> propose to <span class="math inline">\(q\)</span> so that <span class="math inline">\(M(q) = p\)</span>.</li>
<li>For each successor, <span class="math inline">\(s\)</span>, to <span class="math inline">\(p\)</span> in the preference list of <span class="math inline">\(q\)</span>, delete the pair <span class="math inline">\((s, q)\)</span> from the game.</li>
</ol>
<p>This phase of the algorithm will terminate either with every player holding a proposal from one other player, or with exactly one player having an empty preference list. The latter case occurs when an individual has been rejected by every other player (during Step 2) and indicates that no stable matching exists. In the case of the former, the second phase can be carried out so long as there exists at least one player with a preference list containing more than one element.</p>
</section>
<section id="phase-2" class="level3">
<h3 class="anchored" data-anchor-id="phase-2">Phase 2</h3>
<p>The second phase finds and removes all of the all-or-nothing cycles (rotations) from the game. An all-or-nothing cycle represents a series of matches that would immediately result in a blocking pair being formed, hence their removal.</p>
<p>An all-or-nothing cycle is a chain of players where the links in the chain alternate between a player's second choice and that player's worst choice. Once a player has appeared twice as the worst choice for some player(s), a cycle has been found. All cycles begin by taking any player in the game with a second choice in their preference list as the first worst choice.</p>
<p>Based on an all-or-nothing cycle <span class="math inline">\((x_1, y_1), \ldots, (x_n, y_n)\)</span>, for each <span class="math inline">\(i = 1, \ldots, n\)</span>, one must delete from the game all pairs <span class="math inline">\((y_i, z)\)</span> such that <span class="math inline">\(y_i\)</span> prefers <span class="math inline">\(x_{i-1}\)</span> to <span class="math inline">\(z\)</span> where subscripts are taken modulo <span class="math inline">\(n\)</span>.</p>
<p>This is an important point that is omitted from the original paper, but may be found in <code class="interpreted-text" role="cite">GI89</code>.</p>
<p>The essential difference between this statement and that in <code class="interpreted-text" role="cite">Irv85</code> is the removal of unpreferable pairs, identified using an all-or-nothing cycle, in addition to those contained in the cycle. Without doing so, tails of cycles can be removed rather than whole cycles, leaving some conflicting pairs in the game.</p>
<p>At the end of this phase, each player has at most one player in their preference list. Matching each player to the player in the their preference list will result in a stable matching. If any player has an empty list, then no stable matching exists for the game.</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Copyright, Henry Wilde 2023. Powered by <a href="https://quarto.org/docs/websites">Quarto</a> and <a href="https://diataxis.fr">Diátaxis</a>.</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>



</body></html>